name: Security Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        
    - name: Run Bandit Security Scan
      id: bandit
      run: |
        python -m bandit -r . -f json -o bandit-report.json || true
        
        CRITICAL_COUNT=0
        if [ -f bandit-report.json ]; then
          CRITICAL_COUNT=$(python -c "
        import json
          try:
              with open('bandit-report.json') as f:
                  data = json.load(f)
              critical = 0
              for issue in data.get('results', []):
                  if issue.get('issue_severity') == 'HIGH':
                      critical += 1
              print(critical)
          except Exception as e:
              print('0')
          ")
                  fi
                  
                  echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
                  
                  if [ "$CRITICAL_COUNT" -gt 0 ]; then
                    echo "ERROR: Найдено $CRITICAL_COUNT критических уязвимостей!"
                    cat bandit-report.json
                    exit 1
                  else
                    echo "SUCCESS: Критических уязвимостей не найдено"
                  fi
                  
              - name: Check for Debug Mode
                run: |
                  if grep -r "debug=True" . --include="*.py" --include="*.yml" --include="*.yaml" 2>/dev/null | grep -v ".github" | grep -v ".git"; then
                    echo "ERROR: Найден debug=True в production коде!"
                    exit 1
                  else
                    echo "SUCCESS: debug=True не найден в коде"
                  fi
                  
              - name: Check Dependencies Security
                run: |
                  safety check --brief || echo "Safety check completed"
                  
              - name: Generate Security Report
                if: always()
                run: |
                  echo "## Отчёт безопасности" > SECURITY_REPORT.md
                  echo "### Дата: $(date)" >> SECURITY_REPORT.md
                  echo "" >> SECURITY_REPORT.md
                  echo "**Статус проверки:** ${{ job.status == 'success' && ' УСПЕХ' || ' ОШИБКА' }}" >> SECURITY_REPORT.md
                  echo "**Найдено критических уязвимостей:** ${{ steps.bandit.outputs.critical_count || '0' }}" >> SECURITY_REPORT.md
                  
              - name: Upload Security Report
                if: always()
                uses: actions/upload-artifact@v3
                with:
                  name: security-reports
                  path: |
                    SECURITY_REPORT.md
                    bandit-report.json