name: Security Checks

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        
    - name: Run Bandit Security Scan
      id: bandit
      run: |
        # Запускаем Bandit и сохраняем отчёт
        python -m bandit -r . -f json -o bandit-report.json
        
        # Анализируем результаты
        CRITICAL_COUNT=$(python -c "
import json
try:
    with open('bandit-report.json') as f:
        data = json.load(f)
    
    critical = 0
    for issue in data.get('results', []):
        if issue.get('issue_severity') == 'HIGH':
            critical += 1
    
    print(critical)
except:
    print('0')
        ")
        
        echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
        
        if [ "$CRITICAL_COUNT" -gt 0 ]; then
          echo " Найдено $CRITICAL_COUNT критических уязвимостей"
          exit 1
        else
          echo " Критических уязвимостей не найдено"
        fi
        
    - name: Check for Debug Mode
      id: debug_check
      run: |
        # Ищем debug=True в production коде
        if grep -r "debug=True" . --include="*.py" --include="*.yml" --include="*.yaml" | grep -v ".github" | grep -v ".git"; then
          echo " ОШИБКА: Найден debug=True в production коде!"
          echo "Это критическая уязвимость безопасности."
          exit 1
        else
          echo " debug=True не найден в коде"
        fi
        
    - name: Check Dependencies Security
      run: |
        # Проверяем уязвимости в зависимостях
        safety check --brief
        
    - name: Generate Security Report
      if: always()
      run: |
        echo "## Отчёт безопасности" > SECURITY_REPORT.md
        echo "### Дата: $(date)" >> SECURITY_REPORT.md
        echo "" >> SECURITY_REPORT.md
        echo "**Bandit:** ${{ steps.bandit.outputs.critical_count == '0' && ' Пройдено' || ' Не пройдено' }}" >> SECURITY_REPORT.md
        echo "**Debug проверка:** ${{ job.status == 'success' && ' Пройдено' || ' Не пройдено' }}" >> SECURITY_REPORT.md
        
    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          SECURITY_REPORT.md
          bandit-report.json
              - name: Run Security Tests
      run: |
        python -m pytest tests/test_app.py -v
        
    - name: Test Bandit Blocking
      run: |
        # Тестируем что Bandit блокирует плохой код
        echo "Тестирование блокировки Bandit..."
        
        # Создаём временный файл с уязвимостью
        cat > test_vulnerable.py << 'EOF'
        # Тестовый файл с уязвимостью
        DEBUG = True  # Это должно быть заблокировано
        SECRET_KEY = 'password123'  # И это тоже
        EOF
        
        # Запускаем Bandit - должен вернуть ошибку
        if python -m bandit test_vulnerable.py; then
          echo "ОШИБКА: Bandit не заблокировал уязвимый код!"
          exit 1
        else
          echo "УСПЕХ: Bandit корректно заблокировал уязвимый код"
        fi